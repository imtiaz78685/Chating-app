<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Dark Chat</title>
  <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
<style>
  :root{
    --bg:#0a1a18;
    --cardBg:#0f2420;
    --accent:#25d366;
    --muted:#6b7c7a;
    --friendBubble:#1a3530;
    --myBubble:#1e4a3b;
    --error:#ff4757;
    --warning:#ffa502;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:#e6f2f1;overflow:hidden}
  .app{width:100vw;height:100vh;display:flex;flex-direction:column}
  .header{background:var(--cardBg);padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02)}
  .title{display:flex;align-items:center;gap:12px}
  .dot{width:32px;height:32px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;color:#000}
  h3{font-size:18px;margin:0}
  .status{font-size:12px;color:var(--muted)}
  .controls{display:flex;align-items:center;gap:8px}
  .id-box{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);position:relative}
  button.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;transition:all 0.2s}
  button.btn:hover{background:rgba(37,211,102,0.1);border-color:var(--accent)}
  button.btn:disabled{opacity:.45;cursor:not-allowed}
  .body{display:flex;flex-direction:column;height:calc(100vh - 80px)}
  .top-controls{padding:12px;display:flex;gap:8px;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02);flex-wrap:wrap}
  input[type="text"].small{flex:1;min-width:200px;padding:10px;border-radius:8px;background:#042b28;border:1px solid rgba(255,255,255,0.02);color:#e6f2f1;transition:border-color 0.2s}
  input[type="text"].small:focus{outline:none;border-color:var(--accent)}
  .chat-window{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);scroll-behavior:smooth}
  .bubble{max-width:75%;padding:12px 16px;border-radius:18px;color:#e6f2f1;position:relative;word-wrap:break-word;font-size:14px;line-height:1.4;animation:slideIn 0.3s ease}
  .friend{align-self:flex-start;background:linear-gradient(135deg,var(--friendBubble),#0f2b28);border:1px solid rgba(255,255,255,0.03);border-bottom-left-radius:6px}
  .me{align-self:flex-end;background:linear-gradient(135deg,var(--myBubble),#134f3b);border:1px solid rgba(255,255,255,0.03);border-bottom-right-radius:6px}
  .ts{font-size:11px;color:var(--muted);margin-top:6px;opacity:.8}
  .input-area{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
  input[type="text"].msg{flex:1;padding:14px 18px;border-radius:25px;background:#052b29;border:1px solid rgba(255,255,255,0.03);color:#e6f2f1;transition:all 0.2s}
  input[type="text"].msg:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,211,102,0.1)}
  .typing{font-size:12px;color:var(--muted);padding-left:12px;height:18px;font-style:italic}
  .small-muted{font-size:12px;color:var(--muted)}
  .id-actions{display:flex;gap:6px;flex-wrap:wrap}
  .notice{padding:12px;text-align:center;font-size:13px;color:var(--muted);border-top:1px dashed rgba(255,255,255,0.02);background:rgba(0,0,0,0.1)}
  .copyBtn{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;transition:all 0.2s}
  .copyBtn:hover{background:rgba(255,255,255,0.05);color:var(--accent)}
  .connected-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;transition:all 0.3s}
  .connected-indicator.off{background:#6b6b6b}
  .connected-indicator.on{background:var(--accent);box-shadow:0 0 12px rgba(37,211,102,0.3);animation:pulse 2s infinite}
  .system-msg{align-self:center;background:rgba(255,255,255,0.05);color:var(--muted);font-size:12px;padding:6px 12px;border-radius:12px;margin:8px 0}
  .emoji-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:4px;border-radius:4px;transition:background 0.2s}
  .emoji-btn:hover{background:rgba(255,255,255,0.1)}
  .file-input{display:none}
  .attachment-btn{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);transition:all 0.2s}
  .attachment-btn:hover{background:rgba(255,255,255,0.05);color:var(--accent)}
  .sound-toggle{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--muted);font-size:12px;transition:all 0.2s}
  .sound-toggle.on{color:var(--accent);border-color:var(--accent)}
  .message-time{font-size:10px;color:var(--muted);opacity:0.7;margin-left:8px}
  .online-count{font-size:11px;color:var(--accent);margin-left:4px}
  
  @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  
  @media (max-width: 768px){
    .header{padding:12px;flex-direction:column;gap:8px}
    .controls{width:100%;justify-content:space-between}
    .top-controls{flex-direction:column;align-items:stretch}
    .id-actions{width:100%;justify-content:stretch}
    .bubble{max-width:85%}
    input[type="text"].small{min-width:unset}
  }
</style>
</head>
<body>

<div class="app" role="application" aria-label="P2P Dark Chat">
  <div class="header">
    <div class="title">
      <div class="dot">P2</div>
      <div>
        <h3>Dark P2P Chat</h3>
        <div class="status" id="connStatus">Not connected</div>
      </div>
    </div>

    <div class="controls">
      <div class="id-box small-muted">
        Your ID: <span id="myIdText">...</span>
        <span class="online-count" id="onlineCount"></span>
      </div>
      <button class="copyBtn" id="copyBtn">üìã Copy</button>
      <button class="sound-toggle" id="soundToggle" title="Toggle sound notifications">üîä</button>
    </div>
  </div>

  <div class="body">
    <div class="top-controls">
      <input class="small" id="peerToConnect" placeholder="Enter friend's ID to connect" maxlength="50" />
      <div class="id-actions">
        <button class="btn" id="connectBtn">üîó Connect</button>
        <button class="btn" id="resetBtn">üîÑ Reset</button>
        <button class="btn" id="clearBtn">üóëÔ∏è Clear</button>
      </div>
    </div>

    <div id="chat" class="chat-window"></div>

    <div class="notice" id="notice">Share your ID with friend and they will connect ‚Äî messages go direct between browsers.</div>

    <div class="input-area">
      <button class="emoji-btn" id="emojiBtn" title="Add emoji">üòä</button>
      <input class="msg" id="msgInput" placeholder="Type a message..." autocomplete="off" maxlength="500" />
      <button class="attachment-btn" id="attachBtn" title="Send file">üìé</button>
      <input type="file" id="fileInput" class="file-input" accept="image/*,text/*,.pdf" />
      <button class="btn" id="sendBtn">üì§ Send</button>
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;">
      <div class="typing" id="typingIndicator"></div>
      <div class="small-muted">
        <span class="connected-indicator off" id="dot"></span>
        <span id="connText">Disconnected</span>
        <span class="message-time" id="lastSeen"></span>
      </div>
    </div>
  </div>
</div>

<script>
  function escapeHtml(str){
    if(!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  
  function timeNow(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function playNotificationSound(){
    if(soundEnabled){
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
      audio.volume = 0.3;
      audio.play().catch(()=>{});
    }
  }

  const peer = new Peer();
  let conn = null;
  let typingTimeout = null;
  let soundEnabled = true;
  let messageCount = 0;
  let lastActivity = Date.now();

  const myIdText = document.getElementById('myIdText');
  const copyBtn = document.getElementById('copyBtn');
  const connectBtn = document.getElementById('connectBtn');
  const resetBtn = document.getElementById('resetBtn');
  const clearBtn = document.getElementById('clearBtn');
  const peerToConnect = document.getElementById('peerToConnect');
  const chat = document.getElementById('chat');
  const sendBtn = document.getElementById('sendBtn');
  const msgInput = document.getElementById('msgInput');
  const connStatus = document.getElementById('connStatus');
  const typingIndicator = document.getElementById('typingIndicator');
  const connText = document.getElementById('connText');
  const dot = document.getElementById('dot');
  const notice = document.getElementById('notice');
  const soundToggle = document.getElementById('soundToggle');
  const emojiBtn = document.getElementById('emojiBtn');
  const attachBtn = document.getElementById('attachBtn');
  const fileInput = document.getElementById('fileInput');
  const onlineCount = document.getElementById('onlineCount');
  const lastSeen = document.getElementById('lastSeen');

  const emojis = ['üòä','üòÇ','‚ù§Ô∏è','üëç','üëé','üò¢','üòÆ','üò°','üéâ','üî•','üíØ','üëè','üôè','üí™','‚ú®','üéØ'];

  function setConnectedUI(isConnected){
    if(isConnected){
      connStatus.innerText = 'Connected üü¢';
      connText.innerText = 'Online';
      dot.classList.remove('off'); dot.classList.add('on');
      lastSeen.innerText = 'Active now';
      onlineCount.innerText = '(2 online)';
    } else {
      connStatus.innerText = 'Not connected üî¥';
      connText.innerText = 'Offline';
      dot.classList.remove('on'); dot.classList.add('off');
      lastSeen.innerText = lastActivity ? `Last seen ${new Date(lastActivity).toLocaleTimeString()}` : '';
      onlineCount.innerText = '';
    }
  }

  function addMessageBubble(text, who, isSystem = false){
    const wrapper = document.createElement('div');
    if(isSystem){
      wrapper.className = 'system-msg';
      wrapper.innerHTML = `<div>${escapeHtml(text)}</div>`;
    } else {
      wrapper.className = 'bubble ' + (who === 'me' ? 'me' : 'friend');
      wrapper.innerHTML = `
        <div>${escapeHtml(text)}</div>
        <div class="ts">${timeNow()}</div>
      `;
      messageCount++;
      if(who === 'friend') playNotificationSound();
    }
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
    
    // Update document title with unread count
    if(who === 'friend' && document.hidden){
      document.title = `(${messageCount}) P2P Dark Chat`;
    }
  }

  function addFileMessage(fileName, fileData, who){
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble ' + (who === 'me' ? 'me' : 'friend');
    
    if(fileData.startsWith('data:image/')){
      wrapper.innerHTML = `
        <div>üì∑ ${escapeHtml(fileName)}</div>
        <img src="${fileData}" style="max-width:200px;max-height:200px;border-radius:8px;margin-top:8px;" />
        <div class="ts">${timeNow()}</div>
      `;
    } else {
      wrapper.innerHTML = `
        <div>üìé ${escapeHtml(fileName)}</div>
        <a href="${fileData}" download="${fileName}" style="color:var(--accent);text-decoration:none;">Download file</a>
        <div class="ts">${timeNow()}</div>
      `;
    }
    
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
    if(who === 'friend') playNotificationSound();
  }

  function showNotice(text){
    notice.innerHTML = text;
  }

  peer.on('open', id => {
    myIdText.innerText = id;
    showNotice('üöÄ Ready! Share your ID with friend or paste their ID above to connect.');
  });

  peer.on('connection', connection => {
    if(conn && conn.open){
      connection.on('open', ()=> connection.send({type:'system', text:'User is busy'}));
      return;
    }
    conn = connection;
    setupConnection();
  });

  function setupConnection(){
    setConnectedUI(true);
    showNotice('üîó Connected! Messages are encrypted and go direct between browsers.');
    lastActivity = Date.now();

    conn.on('data', handleIncoming);
    conn.on('close', ()=>{
      addMessageBubble('Friend disconnected', '', true);
      setConnectedUI(false);
      conn = null;
    });
    conn.on('error', err=>{
      console.error('Connection error', err);
      addMessageBubble('Connection error occurred', '', true);
      setConnectedUI(false);
    });
  }

  function handleIncoming(data){
    try{
      lastActivity = Date.now();
      
      if(typeof data === 'string'){
        addMessageBubble(data, 'friend');
        return;
      }
      
      if(data.type === 'message'){
        addMessageBubble(data.text, 'friend');
        typingIndicator.innerText = '';
      } 
      else if(data.type === 'file'){
        addFileMessage(data.fileName, data.fileData, 'friend');
      }
      else if(data.type === 'typing'){
        typingIndicator.innerText = '‚úçÔ∏è Friend is typing...';
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(()=> typingIndicator.innerText = '', 2000);
      }
      else if(data.type === 'system'){
        addMessageBubble(data.text, '', true);
      }
    } catch(e){
      console.error('Error handling incoming data:', e);
    }
  }

  connectBtn.addEventListener('click', ()=>{
    const id = peerToConnect.value.trim();
    if(!id){ 
      showNotice('‚ö†Ô∏è Please enter a friend\'s ID to connect.');
      peerToConnect.focus();
      return; 
    }
    if(conn && conn.open){ 
      showNotice('‚ö†Ô∏è Already connected. Reset first to connect to someone else.');
      return; 
    }

    connectBtn.disabled = true;
    connectBtn.innerText = 'üîÑ Connecting...';
    
    conn = peer.connect(id, {reliable:true});
    conn.on('open', ()=>{
      setupConnection();
      conn.send({type:'system', text:'Connected successfully'});
      connectBtn.disabled = false;
      connectBtn.innerText = 'üîó Connect';
      peerToConnect.value = '';
    });
    conn.on('error', (err)=>{ 
      showNotice('‚ùå Connection failed. Check the ID and try again.');
      conn=null; 
      setConnectedUI(false);
      connectBtn.disabled = false;
      connectBtn.innerText = 'üîó Connect';
    });
  });

  resetBtn.addEventListener('click', ()=>{
    if(conn){ try{ conn.close(); }catch(e){} conn = null; }
    setConnectedUI(false);
    addMessageBubble('You disconnected', '', true);
    showNotice('üîÑ Disconnected. Share your ID or connect to friend.');
    peerToConnect.value = '';
  });

  clearBtn.addEventListener('click', ()=>{
    if(confirm('Clear all messages?')){
      chat.innerHTML = '';
      messageCount = 0;
      document.title = 'P2P Dark Chat';
      showNotice('üóëÔ∏è Chat cleared.');
    }
  });

  copyBtn.addEventListener('click', ()=>{
    const id = myIdText.innerText;
    navigator.clipboard.writeText(id).then(()=>{
      copyBtn.innerHTML = '‚úÖ Copied!';
      setTimeout(()=> copyBtn.innerHTML = 'üìã Copy', 1500);
    }).catch(()=>{
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = id;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      copyBtn.innerHTML = '‚úÖ Copied!';
      setTimeout(()=> copyBtn.innerHTML = 'üìã Copy', 1500);
    });
  });

  soundToggle.addEventListener('click', ()=>{
    soundEnabled = !soundEnabled;
    soundToggle.innerHTML = soundEnabled ? 'üîä' : 'üîá';
    soundToggle.classList.toggle('on', soundEnabled);
    localStorage.setItem('soundEnabled', soundEnabled);
  });

  emojiBtn.addEventListener('click', ()=>{
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    msgInput.value += emoji;
    msgInput.focus();
  });

  attachBtn.addEventListener('click', ()=>{
    fileInput.click();
  });

  fileInput.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    
    if(file.size > 5 * 1024 * 1024){
      alert('File too large. Maximum size is 5MB.');
      return;
    }
    
    if(!conn || !conn.open){
      alert('Not connected yet!');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = e.target.result;
      addFileMessage(file.name, fileData, 'me');
      conn.send({type:'file', fileName: file.name, fileData: fileData});
    };
    reader.readAsDataURL(file);
    fileInput.value = '';
  });

  function sendMessage(){
    const txt = msgInput.value.trim();
    if(!txt) return;
    if(!conn || !conn.open){
      showNotice('‚ö†Ô∏è Not connected yet! Connect to a friend first.');
      return;
    }

    addMessageBubble(txt, 'me');
    conn.send({type:'message', text: txt});
    msgInput.value='';
    typingIndicator.innerText='';
  }

  sendBtn.addEventListener('click', sendMessage);

  msgInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ 
      e.preventDefault();
      sendMessage(); 
    }
    else if(conn && conn.open){
      conn.send({type:'typing'});
    }
  });

  msgInput.addEventListener('input', ()=>{
    if(conn && conn.open){
      conn.send({type:'typing'});
    }
  });

  // Load saved settings
  const savedSound = localStorage.getItem('soundEnabled');
  if(savedSound !== null){
    soundEnabled = savedSound === 'true';
    soundToggle.innerHTML = soundEnabled ? 'üîä' : 'üîá';
    soundToggle.classList.toggle('on', soundEnabled);
  }

  // Reset title when window becomes visible
  document.addEventListener('visibilitychange', ()=>{
    if(!document.hidden){
      document.title = 'P2P Dark Chat';
      messageCount = 0;
    }
  });

  // Auto-focus message input
  setConnectedUI(false);
  msgInput.focus();
  
  // Add some helpful shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey || e.metaKey){
      if(e.key === 'k'){
        e.preventDefault();
        peerToConnect.focus();
      }
      else if(e.key === 'l'){
        e.preventDefault();
        clearBtn.click();
      }
    }
  });
</script>
</body>
</html>